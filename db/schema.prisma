// ============================================================================
// Prisma Schema
// Learn more: https://pris.ly/d/prisma-schema
// ============================================================================

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// API ROUTES
// ============================================================================

// 1. **Users** (`/api/users`)
//
// GET    /api/users          # List all users
// POST   /api/users          # Create a new user
// GET    /api/users/:id      # Get a specific user
// PUT    /api/users/:id      # Update a user
// DELETE /api/users/:id      # Delete a user
//
// --------------------------------------------------------------------------

// 2. **Projects** (`/api/projects`)
//
// GET    /api/projects           # List all projects
// POST   /api/projects           # Create a new project
// GET    /api/projects/:id       # Get a specific project
// PUT    /api/projects/:id       # Update a project
// DELETE /api/projects/:id       # Delete a project
//
// --------------------------------------------------------------------------

// 3. **Purchases** (`/api/purchases`)
//
// GET    /api/purchases          # List all purchases
// POST   /api/purchases          # Create a new purchase
// GET    /api/purchases/:id      # Get a specific purchase
// PUT    /api/purchases/:id      # Update a purchase
// DELETE /api/purchases/:id      # Delete a purchase
//
// --------------------------------------------------------------------------

// 4. **Reviews** (`/api/reviews`)
//
// GET    /api/reviews           # List all reviews
// POST   /api/reviews           # Create a new review
// GET    /api/reviews/:id       # Get a specific review
// PUT    /api/reviews/:id       # Update a review
// DELETE /api/reviews/:id       # Delete a review
//
// --------------------------------------------------------------------------

// 5. **Transactions** (`/api/transactions`)
//
// GET    /api/transactions          # List all transactions
// POST   /api/transactions          # Create a new transaction
// GET    /api/transactions/:id      # Get a specific transaction
// PUT    /api/transactions/:id      # Update a transaction
// DELETE /api/transactions/:id      # Delete a transaction
//
// --------------------------------------------------------------------------

// 6. **Categories** (`/api/categories`)
//
// GET    /api/categories           # List all categories
// POST   /api/categories           # Create a new category
// GET    /api/categories/:id       # Get a specific category
// PUT    /api/categories/:id       # Update a category
// DELETE /api/categories/:id       # Delete a category
//
// --------------------------------------------------------------------------

// 7. **Project Tags** (`/api/project-tags`)
//
// GET    /api/project-tags           # List all project tags
// POST   /api/project-tags           # Create a new project tag
// GET    /api/project-tags/:id       # Get a specific project tag
// PUT    /api/project-tags/:id       # Update a project tag
// DELETE /api/project-tags/:id       # Delete a project tag
//
// --------------------------------------------------------------------------

// 8. **Support Tickets** (`/api/support-tickets`)
//
// GET    /api/support-tickets           # List all support tickets
// POST   /api/support-tickets           # Create a new support ticket
// GET    /api/support-tickets/:id       # Get a specific support ticket
// PUT    /api/support-tickets/:id       # Update a support ticket
// DELETE /api/support-tickets/:id       # Delete a support ticket
//
// --------------------------------------------------------------------------

// **Custom Endpoints**
//
// Authentication
// POST   /api/auth/login                # User login
// POST   /api/auth/register             # User registration
// POST   /api/auth/logout               # User logout
// GET    /api/auth/me                   # Get current user
//
// Project-specific
// GET    /api/projects/:id/reviews      # Get reviews for a project
// GET    /api/projects/:id/purchases    # Get purchases for a project
// POST   /api/projects/:id/purchase     # Purchase a project
//
// User-specific
// GET    /api/users/:id/projects        # Get user's projects
// GET    /api/users/:id/purchases       # Get user's purchases
// GET    /api/users/:id/reviews         # Get user's reviews
// PUT    /api/users/:id/wallet          # Update user's wallet
//
// Search & Filters
// GET    /api/projects/search           # Search projects
// GET    /api/projects/category/:id     # Get projects by category
// GET    /api/projects/tech/:stack      # Get projects by tech stack
//
// Admin Routes
// PUT    /api/projects/:id/approve      # Approve a project
// PUT    /api/users/:id/verify          # Verify a seller
// GET    /api/admin/dashboard           # Admin dashboard data
//

// blitz generate all user name:string? email:string:unique hashedPassword:string? walletBalance:float:default=0 profileDetails:json? role:enum:UserRole:default=USER
// blitz generate all project title:string description:string category:string techStack:string[] fileUrl:string price:float isResellAllowed:boolean:default=false isApproved:boolean:default=false belongsTo:user
// blitz generate all purchase amountPaid:float licenseType:enum:LicenseType belongsTo:user belongsTo:project
// blitz generate all review rating:int comment:string belongsTo:user belongsTo:project
// blitz generate all transaction type:enum:TransactionType amount:float paymentMethod:enum:PaymentMethod belongsTo:user
// blitz generate all category name:string:unique description:string
// blitz generate all projectTag belongsTo:project belongsTo:category
// blitz generate all supportTicket issueType:enum:IssueType status:enum:TicketStatus:default=OPEN description:string resolvedAt:datetime? belongsTo:user belongsTo:project

// ============================================================================
// MODELS
// ============================================================================

model User {
  id             Int      @id @default(autoincrement())
  name           String?
  email          String   @unique
  phone          Int?     @unique
  age            Int?
  gender         Gender?
  hashedPassword String?
  walletBalance  Float    @default(0)
  role           UserRole @default(USER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tokens         Token[]
  sessions       Session[]
  projects       Project[]
  purchases      Purchase[]
  reviews        Review[]
  transactions   Transaction[]
  supportTickets SupportTicket[]
}

model Session {
  id                 Int       @id @default(autoincrement())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  expiresAt          DateTime?
  handle             String    @unique
  hashedSessionToken String?
  antiCSRFToken      String?
  publicData         String?
  privateData        String?

  user   User? @relation(fields: [userId], references: [id])
  userId Int?
}

model Token {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hashedToken String
  type        String
  expiresAt   DateTime
  sentTo      String

  user   User @relation(fields: [userId], references: [id])
  userId Int

  @@unique([hashedToken, type])
}

model Purchase {
  id          Int         @id @default(autoincrement())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  amountPaid  Float
  licenseType LicenseType

  user   User @relation(fields: [userId], references: [id])
  userId Int

  project   Project @relation(fields: [projectId], references: [id])
  projectId Int
}

model Review {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  rating        Int      @default(5) @db.SmallInt
  comment       String
  averageRating Float?   @default(0) // New field for average rating
  ratingcount   Int?     @default(0) // New field for rating count
  user          User     @relation(fields: [userId], references: [id])
  userId        Int

  project   Project @relation(fields: [projectId], references: [id])
  projectId Int
}

model Transaction {
  id            Int             @id @default(autoincrement())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  type          TransactionType
  amount        Float
  paymentMethod PaymentMethod

  user   User @relation(fields: [userId], references: [id])
  userId Int
}

model Category {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String   @unique
  description String

  projectTags ProjectTag[]
}

model ProjectTag {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project @relation(fields: [projectId], references: [id])
  projectId Int

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId Int

  @@unique([projectId, categoryId])
}

model SupportTicket {
  id          Int          @id @default(autoincrement())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  issueType   IssueType
  status      TicketStatus @default(OPEN)
  description String
  resolvedAt  DateTime?

  user   User @relation(fields: [userId], references: [id])
  userId Int

  project   Project? @relation(fields: [projectId], references: [id])
  projectId Int?
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  USER
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum LicenseType {
  ORIGINAL
  RESALE
}

enum TransactionType {
  CREDIT
  DEBIT
  COMMISSION
}

enum PaymentMethod {
  UPI
  PAYPAL
  STRIPE
  BANK_TRANSFER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum IssueType {
  DISPUTE
  REFUND
  BUG
  QUERY
}

// model Project {
//   id              Int      @id @default(autoincrement())
//   createdAt       DateTime @default(now())
//   updatedAt       DateTime @updatedAt
//   title           String
//   description     String
//   category        String
//   techStack       String[]
//   fileUrl         String
//   price           Float
//   isResellAllowed Boolean  @default(false)
//   isApproved      Boolean  @default(false)

//   user   User @relation(fields: [userId], references: [id])
//   userId Int

//   Purchase      Purchase[]
//   Review        Review[]
//   ProjectTag    ProjectTag[]
//   SupportTicket SupportTicket[]
// }

model Project {
  id                 Int             @id @default(autoincrement())
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  title              String
  description        String
  category           String[]
  tags               String[]
  techStack          String[]
  projectImages      String[]
  slug               String          @unique
  fileUrl            String
  price              Float
  isResellAllowed    Boolean         @default(false)
  isApproved         Boolean         @default(false)
  views              Int             @default(0)
  downloads          Int             @default(0)
  metaTitle          String?
  metaDescription    String?
  metaKeywords       String?
  ogTitle            String?
  ogDescription      String?
  ogImage            String?
  twitterTitle       String?
  twitterDescription String?
  twitterImage       String?
  canonicalUrl       String?
  robots             String?         @default("index, follow")
  // Example: "noindex, nofollow", "index, follow"
  demoUrl            String?
  repositoryUrl      String?
  visibility         String          @default("public")
  user               User            @relation(fields: [userId], references: [id])
  userId             Int
  Purchase           Purchase[]
  Review             Review[]
  ProjectTag         ProjectTag[]
  SupportTicket      SupportTicket[]
}

// model User {
//   id          Int       @id @default(autoincrement())
//   email       String    @unique
//   password    String
//   name        String?
//   projects    Project[] // Projects created by the user
//   orders      Order[]   // Orders made by the user
//   reviews     Review[]  // Reviews written by the user
//   createdAt   DateTime  @default(now())
//   updatedAt   DateTime  @updatedAt
// }

// model Project {
//   id          Int        @id @default(autoincrement())
//   title       String
//   description String
//   price       Float
//   imageUrl    String?
//   category    Category   @relation(fields: [categoryId], references: [id])
//   categoryId  Int
//   seller      User       @relation(fields: [sellerId], references: [id])
//   sellerId    Int
//   orders      Order[]    // Orders that include this project
//   reviews     Review[]   // Reviews for this project
//   createdAt   DateTime   @default(now())
//   updatedAt   DateTime   @updatedAt
// }

// model Category {
//   id        Int       @id @default(autoincrement())
//   name      String    @unique
//   projects  Project[]
// }

// model Order {
//   id          Int       @id @default(autoincrement())
//   buyer       User      @relation(fields: [buyerId], references: [id])
//   buyerId     Int
//   project     Project   @relation(fields: [projectId], references: [id])
//   projectId   Int
//   totalPrice  Float
//   status      OrderStatus @default(PENDING)
//   createdAt   DateTime  @default(now())
//   updatedAt   DateTime  @updatedAt
// }

// enum OrderStatus {
//   PENDING
//   COMPLETED
//   CANCELLED
// }

// model Review {
//   id          Int       @id @default(autoincrement())
//   rating      Int       @default(5) @db.SmallInt
//   comment     String?
//   project     Project   @relation(fields: [projectId], references: [id])
//   projectId   Int
//   author      User      @relation(fields: [authorId], references: [id])
//   authorId    Int
//   createdAt   DateTime  @default(now())
// }
